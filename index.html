<script>
    const MAX_PASSAGES_PER_DAY = 4;
    const MIN_INTERVAL = 300000; // 5 minutos
    const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbx_4CEY6Jman7yJHWyx2WQtVCyf-aVkJOZhfsfiKkv6qYj0WDB6-wBlGfckJH2hCGZW/exec";

    function canRegister(qrData) {
        const [nomeRazaoSocial, cpf, placa] = qrData.split(',');
        const today = new Date().toLocaleDateString();
        
        let dailyPassages = JSON.parse(localStorage.getItem("dailyPassages")) || { date: today, plates: {} };

        // Reset diário
        if (dailyPassages.date !== today) {
            dailyPassages = { date: today, plates: {} };
        }

        // Prefeitura e Secretaria têm passagens ilimitadas
        if (nomeRazaoSocial.toLowerCase().includes("prefeitura") || nomeRazaoSocial.toLowerCase().includes("secretaria")) {
            return true;
        }

        // Verifica se a placa já passou 4 vezes no dia
        if (dailyPassages.plates[placa] >= MAX_PASSAGES_PER_DAY) {
            alert(`🚨 A placa ${placa} já atingiu o limite de 4 passagens hoje!`);
            return false;
        }

        // Atualiza a contagem
        dailyPassages.plates[placa] = (dailyPassages.plates[placa] || 0) + 1;
        localStorage.setItem("dailyPassages", JSON.stringify(dailyPassages));

        return true;
    }

    function sendToGoogleSheets(qrData) {
        fetch(GOOGLE_SHEETS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qrData })
        })
        .then(response => {
            if (response.ok) {
                console.log("✅ Dados enviados com sucesso!");
            } else {
                console.error("❌ Falha no envio:", response.status);
                storeDataOffline(qrData);
            }
        })
        .catch(err => {
            console.error("❌ Erro ao enviar:", err);
            storeDataOffline(qrData);
        });
    }

    function storeDataOffline(qrData) {
        let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
        offlineData.push({ data: qrData, timestamp: new Date().toISOString() });
        localStorage.setItem("offlineData", JSON.stringify(offlineData));
    }

    function sendOfflineData() {
        let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
        offlineData.forEach((entry, index) => {
            sendToGoogleSheets(entry.data);
            offlineData.splice(index, 1);
        });
        localStorage.setItem("offlineData", JSON.stringify(offlineData));
    }

    function cleanOldData() {
        let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
        let sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        offlineData = offlineData.filter(entry => new Date(entry.timestamp) >= sevenDaysAgo);
        localStorage.setItem("offlineData", JSON.stringify(offlineData));
    }

    setInterval(sendOfflineData, 30000); // Tentar reenviar dados a cada 30 segundos
    setInterval(cleanOldData, 86400000); // Limpar dados antigos a cada 24 horas
</script>
